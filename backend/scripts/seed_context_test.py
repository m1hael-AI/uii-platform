"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∂–∞—Ç–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (Context Compression).
–ó–∞–≥—Ä—É–∂–∞–µ—Ç ~13k —Ç–æ–∫–µ–Ω–æ–≤ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python backend/scripts/seed_context_test.py

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –û–î–ù–û –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (>300 —Å–ª–æ–≤) –≤ —á–∞—Ç,
—á—Ç–æ–±—ã –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ø–æ—Ä–æ–≥ 12,800 —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∂–∞—Ç–∏–µ.
"""

import asyncio
import sys
import os
from pathlib import Path

# Add backend to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from models import Message, MessageRole, ChatSession, User
from database import async_session_factory
from services.chat_session_service import get_or_create_chat_session
from datetime import datetime, timedelta
import json

# –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ (Python –æ–±—É—á–µ–Ω–∏–µ)
USER_MSGS = [
    "–ü—Ä–∏–≤–µ—Ç! –Ø —Ö–æ—á—É –Ω–∞—á–∞—Ç—å –∏–∑—É—á–∞—Ç—å Python –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö. –° —á–µ–≥–æ –º–Ω–µ –ª—É—á—à–µ –Ω–∞—á–∞—Ç—å?",
    "–ê –∫–∞–∫–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –º–Ω–µ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?",
    "–ú–æ–∂–µ—à—å –æ–±—ä—è—Å–Ω–∏—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ø–∏—Å–æ–∫ (list) –≤ Python? –ò —á–µ–º –æ–Ω –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∫–æ—Ä—Ç–µ–∂–∞?",
    "–ü–æ–Ω—è—Ç–Ω–æ. –ê –∫–∞–∫ –º–Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å CSV —Ñ–∞–π–ª? –î–æ–ø—É—Å—Ç–∏–º, —É –º–µ–Ω—è —Ç–∞–º —Ç–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏.",
    "–ê –µ—Å–ª–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø–æ —ç—Ç–∏–º –¥–∞–Ω–Ω—ã–º? –ß—Ç–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: Matplotlib –∏–ª–∏ Seaborn?",
    "–Ø —Å–ª—ã—à–∞–ª –ø—Ä–æ Pandas. –≠—Ç–æ —Ç–∏–ø–∞ —ç–∫—Å–µ–ª—è –≤–Ω—É—Ç—Ä–∏ –ø–∏—Ç–æ–Ω–∞? –ö–∞–∫ —Ç–∞–º —Å–¥–µ–ª–∞—Ç—å —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É?",
    "–°–ª—É—à–∞–π, –∞ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏–∏? –Ø –ø—Ä–æ–±—É—é –Ω–∞–ø–∏—Å–∞—Ç—å def my_func, –Ω–æ –æ–Ω–∞ –Ω–µ –≤–∏–¥–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–Ω–∞—Ä—É–∂–∏.",
    "–ê —á—Ç–æ —Ç–∞–∫–æ–µ lambda —Ñ—É–Ω–∫—Ü–∏–∏? –ó–∞—á–µ–º –æ–Ω–∏ –Ω—É–∂–Ω—ã, –µ—Å–ª–∏ –µ—Å—Ç—å –æ–±—ã—á–Ω—ã–µ def?",
    "–ú–Ω–µ –Ω—É–∂–Ω–æ —Å–ø–∞—Ä—Å–∏—Ç—å —Å–∞–π—Ç. –ö–∞–∫—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É –ø–æ—Å–æ–≤–µ—Ç—É–µ—à—å? Requests –∏–ª–∏ Selenium?",
    "–ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö? –ù–∞–ø—Ä–∏–º–µ—Ä, –≤ PostgreSQL. –ù—É–∂–µ–Ω –∫–∞–∫–æ–π-—Ç–æ –¥—Ä–∞–π–≤–µ—Ä?",
    "–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∫–ª–∞—Å—Å—ã –∏ –û–û–ü. –ó–∞—á–µ–º –º–Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–ª–∞—Å—Å User, –µ—Å–ª–∏ —è –º–æ–≥—É –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞—Ä—å?",
    "–ê –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ? –ï—Å–ª–∏ —É –º–µ–Ω—è –µ—Å—Ç—å –∫–ª–∞—Å—Å Animal –∏ –∫–ª–∞—Å—Å Dog.",
    "–ß—Ç–æ —Ç–∞–∫–æ–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã? –Ø –≤–∏–¥–µ–ª @app.route –≤–æ Flask, –Ω–æ –Ω–µ –ø–æ–Ω–∏–º–∞—é –º–∞–≥–∏—é.",
    "–ö–∞–∫ –º–Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫–∏? –£ –º–µ–Ω—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–∞–¥–∞–µ—Ç, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.",
    "–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤ Python (asyncio) - —ç—Ç–æ —Å–ª–æ–∂–Ω–æ? –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?",
    "–ö–∞–∫ –º–Ω–µ —É—Å–∫–æ—Ä–∏—Ç—å –∫–æ–¥? –£ –º–µ–Ω—è —Ü–∏–∫–ª for —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ –Ω–∞ –±–æ–ª—å—à–æ–º —Å–ø–∏—Å–∫–µ.",
    "–ß—Ç–æ —Ç–∞–∫–æ–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã? Yield –≤–º–µ—Å—Ç–æ return - –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?",
    "–ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥? Pytest –∏–ª–∏ Unittest?",
    "–ö–∞–∫ –º–Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–æ–µ–≥–æ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ? –ß—Ç–æ —Ç–∞–∫–æ–µ Docker?",
    "–ê –∫–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å ChatGPT API –∫ –º–æ–µ–º—É –ø–∏—Ç–æ–Ω —Å–∫—Ä–∏–ø—Ç—É?"
]

ASSISTANT_MSGS = [
    "–ü—Ä–∏–≤–µ—Ç! –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä. –î–ª—è —Å—Ç–∞—Ä—Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Anaconda –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ Python —Å VS Code. –ù–∞—á–Ω–∏ —Å –±–∞–∑–æ–≤–æ–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Ü–∏–∫–ª—ã, —É—Å–ª–æ–≤–∏—è. –ü–æ—Ç–æ–º –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ Pandas.",
    "–û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–µ–∫ –¥–ª—è Data Science: Pandas (—Ä–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏), NumPy (–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞), Matplotlib/Seaborn (–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è) –∏ Scikit-learn (–º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ).",
    "–°–ø–∏—Å–æ–∫ (list) - —ç—Ç–æ –∏–∑–º–µ–Ω—è–µ–º–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è [1, 2, 3]. –¢—ã –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —É–¥–∞–ª—è—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã. –ö–æ—Ä—Ç–µ–∂ (tuple) (1, 2, 3) - –Ω–µ–∏–∑–º–µ–Ω—è–µ–º. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä—Ç–µ–∂–∏, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –º–µ–Ω—è—Ç—å—Å—è.",
    "–î–ª—è CSV –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç Pandas. `df = pd.read_csv('file.csv')`. –≠—Ç–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç —Ñ–∞–π–ª –≤ DataFrame, —Å –∫–æ—Ç–æ—Ä—ã–º –æ—á–µ–Ω—å —É–¥–æ–±–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å.",
    "Matplotlib - —ç—Ç–æ –±–∞–∑–∞, –æ–Ω –º–æ—â–Ω—ã–π, –Ω–æ –∫–æ–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –≥—Ä–æ–º–æ–∑–¥–∫–∏–º. Seaborn - —ç—Ç–æ –Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–¥ –Ω–∏–º, –¥–µ–ª–∞–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ—á–∫—É. –î–ª—è –Ω–∞—á–∞–ª–∞ –±–µ—Ä–∏ Seaborn.",
    "–ò–º–µ–Ω–Ω–æ! Pandas DataFrame –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂ –Ω–∞ Excel. –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `df.pivot_table(index='Category', values='Sales', aggfunc='sum')`.",
    "–≠—Ç–æ –≤–æ–ø—Ä–æ—Å –æ '–æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏' (scope). –§—É–Ω–∫—Ü–∏—è –≤–∏–¥–∏—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∏—Ö –º–µ–Ω—è—Ç—å, –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å `global x`, –Ω–æ –ª—É—á—à–µ —Ç–∞–∫ –Ω–µ –¥–µ–ª–∞—Ç—å. –ü–µ—Ä–µ–¥–∞–≤–∞–π –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ã.",
    "Lambda - —ç—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–µ –∞–Ω–æ–Ω–∏–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É. –£–¥–æ–±–Ω–æ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ map/filter. –ù–∞–ø—Ä–∏–º–µ—Ä: `sorted(users, key=lambda x: x['age'])`.",
    "–ï—Å–ª–∏ —Å–∞–π—Ç –ø—Ä–æ—Å—Ç–æ–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π HTML - –±–µ—Ä–∏ Requests + BeautifulSoup (–±—ã—Å—Ç—Ä–æ). –ï—Å–ª–∏ —Ç–∞–º –º–Ω–æ–≥–æ JavaScript (React, Vue) –∏ –Ω—É–∂–Ω–æ –∫–ª–∏–∫–∞—Ç—å –∫–Ω–æ–ø–∫–∏ - –±–µ—Ä–∏ Selenium –∏–ª–∏ Playwright.",
    "–î–∞, –Ω—É–∂–µ–Ω –¥—Ä–∞–π–≤–µ—Ä `psycopg2` –∏–ª–∏ ORM —Ç–∏–ø–∞ `SQLAlchemy`. SQLAlchemy –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–æ–π –∫–∞–∫ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ Python, –Ω–µ –Ω–∞–ø–∏—Å–∞–≤ –Ω–∏ —Å—Ç—Ä–æ—á–∫–∏ SQL.",
    "–°–ª–æ–≤–∞—Ä—å —Ö–æ—Ä–æ—à –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ù–æ –ö–ª–∞—Å—Å –¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ –º–µ—Ç–æ–¥—ã (–ø–æ–≤–µ–¥–µ–Ω–∏–µ). User –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –º–µ—Ç–æ–¥ `user.send_email()`. –í —Å–ª–æ–≤–∞—Ä–µ —Ç—ã –ø—Ä–æ—Å—Ç–æ —Ö—Ä–∞–Ω–∏—à—å –¥–∞–Ω–Ω—ã–µ.",
    "–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–¥. `class Dog(Animal):` –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –°–æ–±–∞–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –º–µ—Ç–æ–¥—ã –ñ–∏–≤–æ—Ç–Ω–æ–≥–æ (–µ—Å—Ç—å, —Å–ø–∞—Ç—å) –∏ –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ (–ª–∞—è—Ç—å).",
    "–î–µ–∫–æ—Ä–∞—Ç–æ—Ä - —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è-–æ–±–µ—Ä—Ç–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –º–µ–Ω—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥—Ä—É–≥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏. `@login_required` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–æ—à–µ–ª –ª–∏ —é–∑–µ—Ä, –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –ø—É—Å—Ç–∏—Ç—å –µ–≥–æ –≤ —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è.",
    "–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é try-except. `try: f = open('file.txt') except FileNotFoundError: print('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω')`. –≠—Ç–æ —Å–ø–∞—Å–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É –æ—Ç –ø–∞–¥–µ–Ω–∏—è.",
    "Asyncio –Ω—É–∂–µ–Ω –¥–ª—è I/O –æ–ø–µ—Ä–∞—Ü–∏–π (—Å–µ—Ç—å, –¥–∏—Å–∫), —á—Ç–æ–±—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –Ω–µ –∂–¥–∞–ª –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞, –∞ –¥–µ–ª–∞–ª –¥—Ä—É–≥–∏–µ –¥–µ–ª–∞. –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –±–æ—Ç–æ–≤ –∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–≤ —Å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π.",
    "–ü–æ–ø—Ä–æ–±—É–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `list comprehension` –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–∞, —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ. –ò–ª–∏, –µ—Å–ª–∏ —ç—Ç–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–π –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—é NumPy - –æ–Ω–∞ –≤ 100 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ —Ü–∏–∫–ª–æ–≤.",
    "Yield –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä. –û–Ω–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å—ë —Å—Ä–∞–∑—É (–∫–∞–∫ return), –∞ –≤—ã–¥–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –æ–¥–Ω–æ–º—É, —ç–∫–æ–Ω–æ–º—è –ø–∞–º—è—Ç—å. `range()` - —ç—Ç–æ –ª–µ–Ω–∏–≤–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å.",
    "Pytest - —Å—Ç–∞–Ω–¥–∞—Ä—Ç –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ —Å–µ–π—á–∞—Å. –û–Ω –ø—Ä–æ—â–µ, —Ç—Ä–µ–±—É–µ—Ç –º–µ–Ω—å—à–µ –±–æ–π–ª–µ—Ä–ø–ª–µ–π—Ç–∞, —á–µ–º Unittest, –∏ –∏–º–µ–µ—Ç –∫—Ä—É—Ç—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã.",
    "Docker —É–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç —Ç–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ –≤—Å–µ–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä. –û–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ –Ω–∞ —Ç–≤–æ–µ–º –Ω–æ—É—Ç–µ –∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –≠—Ç–æ –º–∞—Å—Ç—Ö—ç–≤.",
    "–ù—É–∂–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `openai`. –ü–æ–ª—É—á–∏ –∫–ª—é—á API, —Å–¥–µ–ª–∞–π `client = OpenAI(api_key='...')` –∏ –≤—ã–∑—ã–≤–∞–π `client.chat.completions.create()`. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ!"
]

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
TARGET_AGENT_SLUG = "main_assistant"  # –ú–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ –ª—é–±–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
TARGET_TOKENS = 12900  # –ß—É—Ç—å –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞ 12,800 –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏


async def seed_chat_history():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    async with async_session_factory() as db:
        # 1. –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        res = await db.execute(select(User).order_by(User.id.desc()).limit(1))
        user = res.scalar_one_or_none()
        
        if not user:
            print("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ!")
            return

        print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω: ID {user.id} ({user.email})")

        # 2. –ù–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é (–∞—Ç–æ–º–∞—Ä–Ω–æ)
        print(f"üìù –ü–æ–ª—É—á–∞—é –∏–ª–∏ —Å–æ–∑–¥–∞—é —Å–µ—Å—Å–∏—é –¥–ª—è –∞–≥–µ–Ω—Ç–∞ '{TARGET_AGENT_SLUG}'...")
        session = await get_or_create_chat_session(
            db=db,
            user_id=user.id,
            agent_slug=TARGET_AGENT_SLUG
        )
        print(f"‚úÖ –°–µ—Å—Å–∏—è ID {session.id} –≥–æ—Ç–æ–≤–∞.")
            # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é
            # from sqlalchemy import delete
            # await db.execute(delete(Message).where(Message.session_id == session.id))
            # await db.commit()
            # print("üóëÔ∏è  –°—Ç–∞—Ä–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.")

        # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
        messages_to_add = []
        base_time = datetime.utcnow() - timedelta(hours=2)  # 2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥
        
        print(f"üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –¥–∏–∞–ª–æ–≥ (~{TARGET_TOKENS} —Ç–æ–∫–µ–Ω–æ–≤)...")
        
        # –¶–∏–∫–ª–∏—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω—ã –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ –æ–±—ä–µ–º–∞
        i = 0
        msg_count = 0
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ~58 –ø–∞—Ä —Å–æ–æ–±—â–µ–Ω–∏–π (116 —Å–æ–æ–±—â–µ–Ω–∏–π)
        while msg_count < 58:
            u_msg = USER_MSGS[i % len(USER_MSGS)]
            a_msg = ASSISTANT_MSGS[i % len(ASSISTANT_MSGS)]
            
            # –î–µ–ª–∞–µ–º –æ—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–º–∏
            a_msg_long = f"{a_msg}\n\n{a_msg}\n\n–í–æ—Ç –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞:\n```python\ndef example():\n    pass\n```\n{a_msg}"
            
            msg_time_user = base_time + timedelta(minutes=msg_count * 2)
            msg_time_ai = msg_time_user + timedelta(seconds=30)
            
            # User message
            messages_to_add.append(Message(
                session_id=session.id,
                role=MessageRole.USER,
                content=u_msg,
                created_at=msg_time_user
            ))
            
            # Assistant message
            messages_to_add.append(Message(
                session_id=session.id,
                role=MessageRole.ASSISTANT,
                content=a_msg_long,
                created_at=msg_time_ai
            ))
            
            i += 1
            msg_count += 1
        
        db.add_all(messages_to_add)
        await db.commit()
        
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(messages_to_add)} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ—Å—Å–∏—é {session.id}")
        print(f"üìä –ê–≥–µ–Ω—Ç: {TARGET_AGENT_SLUG}")
        print(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.email}")
        print("\n" + "="*60)
        print("üß™ –¢–ï–°–¢ –ì–û–¢–û–í!")
        print("="*60)
        print("\nüìù –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:")
        print(f"   1. –ó–∞–π–¥–∏ –≤ —á–∞—Ç —Å –∞–≥–µ–Ω—Ç–æ–º '{TARGET_AGENT_SLUG}'")
        print("   2. –û—Ç–ø—Ä–∞–≤—å –û–î–ù–û –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (>300 —Å–ª–æ–≤)")
        print("   3. –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏: docker-compose logs -f backend | grep Context")
        print("\nüîç –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ª–æ–≥–∞—Ö:")
        print("   ‚ö†Ô∏è  Context Overflow: XXXX/128000 tokens")
        print("   üßπ Starting context compression...")
        print("   ‚úÖ Context compressed. Deleted XX msgs.")
        print("\n")

if __name__ == "__main__":
    asyncio.run(seed_chat_history())
